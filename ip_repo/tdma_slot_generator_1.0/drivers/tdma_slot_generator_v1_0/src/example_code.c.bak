#include "tdma_slot_generator.h"
#include "stdio.h"
#include "stdlib.h"
#include "xscugic.h"
#include "platform.h"
#include "time.h"
#include "xil_exception.h"
#include "xil_io.h"
#include "xparameters.h"

/* xparameters.h is not generating the proper address ranges - must hardcore */
#define TDMA_SLOT_GEN_INTR_BASE 0x43c10000 /* from vivado address editor */
#define TDMA_SLOT_GEN_BASE  0x43c00000     /* from vivado address editor */

/* interrupt id for button_interrupt IP Core */
#define TDMA_SLOT_GEN_INTERRUPT_ID   XPAR_FABRIC_TDMA_SLOT_GENERATOR_0_IRQ_INTR

/* define GIC */
#define INTC_DEVICE_ID                  XPAR_PS7_SCUGIC_0_DEVICE_ID

/* parameters matching the IP Cores settings for the GIC */
#define INT_EDGE_DETECTION 0x3  /* rising edge detection */
#define INT_PRIORITY       0xA0

/* instance of the IP Core */
static Xtdma_slot_gen SLOT_GEN_INST;

/* instance of the GIC */
static XScuGic Intc;

/* Function prototypes */
int SetupInterruptSystem();
void handler();

/* global interrupt count - reset each new pulse */
static int count = 0;

/* Main */
int main()
{
    init_platform();

    /* enable and reset core */
    printf("\n------------------------------------------------\n\r");
    printf("Enable and Reset tdma_slota_generator IP Core...\n\r");
    TDMA_SLOT_GENERATOR_mWriteReg(TDMA_SLOT_GEN_BASE,
    		TDMA_SLOT_GENERATOR_STATUS_REG_OFFSET, EN_BIT | RST_BIT);
    TDMA_SLOT_GENERATOR_mWriteReg(TDMA_SLOT_GEN_BASE,
    		TDMA_SLOT_GENERATOR_STATUS_REG_OFFSET, EN_BIT);

    /* get duty cycle / slot duration from core -> calculate number of slots */
    uint32_t duration = TDMA_SLOT_GENERATOR_mReadReg(TDMA_SLOT_GEN_BASE,
    		TDMA_SLOT_GENERATOR_S00_TDMA_DURATION_DEBUG_OFFSET);
    uint32_t duty = TDMA_SLOT_GENERATOR_mReadReg(TDMA_SLOT_GEN_BASE,
    		TDMA_SLOT_GENERATOR_S00_TDMA_DUTY_DEBUG_OFFSET);
    int num_slots = 1000/duration; /* 1000 ms / duration of a slot in ms */
    printf("Slot duration : %d ms, Duty Cycle : %d%%\n\r",duration,duty);
    printf("Expect %d interrupt's per input pulse\n\r",num_slots);

    /* enable interrupts */
    printf("Enabling interrupts for new slot pulses\n\r");
    printf("------------------------------------------------\n\r");
    SetupInterruptSystem();

    /* send new pulse every 1sec */
	while(1){
		printf(">>> Pulse simulated...\n\r");
		count = 0;
		TDMA_SLOT_GENERATOR_mWriteReg(TDMA_SLOT_GEN_BASE,
				TDMA_SLOT_GENERATOR_GPS_PPS_REG_DEBUG_OFFSET, GPS_PPS_BIT);
		/* interrupt doesn't trigger until pulse goes low */
		TDMA_SLOT_GENERATOR_mWriteReg(TDMA_SLOT_GEN_BASE,
				TDMA_SLOT_GENERATOR_GPS_PPS_REG_DEBUG_OFFSET, 0x0);
		/* core resets if pulses are received faster than 1 Hz */
		sleep(1);
	}

	/* disables core and cleans platform */
	TDMA_SLOT_GENERATOR_mWriteReg(TDMA_SLOT_GEN_BASE,
			TDMA_SLOT_GENERATOR_STATUS_REG_OFFSET, 0);
	cleanup_platform();

	return 0;
}

/* Enables the GIC and connects the IP Core and Handler */
int SetupInterruptSystem()
{
	int 	xstatus;
	XScuGic	*IntcInstancePtr = &Intc;

	XScuGic_Config *IntcConfig;

	/* Initialize the interrupt controller driver so that it is ready to use. */
	IntcConfig = XScuGic_LookupConfig(INTC_DEVICE_ID);
	if (NULL == IntcConfig) {
		return XST_FAILURE;
	}

	/* IntcInstancePtr Pointer to ScuGic instance */
	xstatus = XScuGic_CfgInitialize(IntcInstancePtr, IntcConfig,
					IntcConfig->CpuBaseAddress);
	if (xstatus != XST_SUCCESS) {
		return XST_FAILURE;
	}

	/* Initialize the exception table and register the interrupt */
	/* controller handler with the exception table */
	Xil_ExceptionInit();
	Xil_ExceptionRegisterHandler(XIL_EXCEPTION_ID_INT,
				 (Xil_ExceptionHandler)XScuGic_InterruptHandler, IntcInstancePtr);

	/* Enable non-critical exceptions */
	Xil_ExceptionEnable();
	XScuGic_SetPriorityTriggerType(IntcInstancePtr, TDMA_SLOT_GEN_INTERRUPT_ID,
					INT_PRIORITY, INT_EDGE_DETECTION);

	/* Connect the interrupt handler that will be called when an */
	/* interrupt occurs for the device. */
	xstatus = XScuGic_Connect(IntcInstancePtr, TDMA_SLOT_GEN_INTERRUPT_ID,
				 (Xil_ExceptionHandler)handler, &SLOT_GEN_INST);
	if (xstatus != XST_SUCCESS) {
		return xstatus;
	}

	/* Enable the interrupt for the CustomIp device. */
	XScuGic_Enable(IntcInstancePtr, TDMA_SLOT_GEN_INTERRUPT_ID);

	/* Enable the interrupts on the Core */
	TDMA_SLOT_GENERATOR_EnableInterrupt(TDMA_SLOT_GEN_INTR_BASE);

	return XST_SUCCESS;
}

/* Exception handler for interrupts */
void handler()
{
	printf("interrupt %d\n\r",count++);
	/* acknowledge interrupt */
	TDMA_SLOT_GENERATOR_ACK(TDMA_SLOT_GEN_INTR_BASE);
	return;
}
